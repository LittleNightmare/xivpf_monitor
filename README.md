# XIVPF 招募监视器

一个用于监视 Final Fantasy XIV 招募信息的工具，基于 [remote-party-finder API](https://github.com/LittleNightmare/remote-party-finder/wiki/API-Usage) 开发。

## 功能特性

### 🔍 智能搜索与过滤
- **多条件过滤**：支持分类、服务器、大区、搜索关键字、副本等多种过滤条件
- **高级过滤**：
  - **排除已有职业**：过滤掉已有特定职业的招募（如排除已有坦克的队伍）
  - **空位数控制**：设置最少空位数、最多已填充位数
  - **新手友好**：过滤是否欢迎新手的招募
  - **内容关键字过滤**：根据招募描述中的关键字进行过滤（如"速通", "练习", "固定队"）
- **预设过滤器**：内置常用过滤器模板，如"高难度副本"、"需要坦克的队伍"、"速通团队"等
- **实时通知**：找到匹配招募时立即通知（支持系统通知和控制台输出）

### 📈 招募监视
- **指定监视**：可以添加特定招募ID进行实时监视
- **更新检测**：监测招募信息变化（人数变化、状态更新等）
- **过期检测**：
  - 基于时间阈值：超过指定时间未更新则视为过期
  - 基于排序规则：根据API返回的排序检测招募消失

### ⚙️ 智能缓存处理
- **双重缓存适配**：针对API服务器30秒缓存 + Cloudflare 30秒缓存进行优化
- **智能检查间隔**：默认90秒检查间隔，避免无效请求
- **缓存感知**：了解最多60秒的数据延迟，合理设置期望值

## 安装使用

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 运行程序
```bash
python main.py
```

### 3. 主要功能

#### 📋 主菜单选项
1. **开始监视** - 根据设置的过滤器持续监视招募
2. **管理过滤器** - 添加、删除、启用/禁用过滤条件
3. **管理监视目标** - 添加特定招募ID进行监视
4. **搜索招募** - 临时搜索招募（可使用现有过滤器或创建临时条件）
5. **设置** - 调整检查间隔、过期阈值、通知设置等
6. **退出** - 安全退出程序

#### 🔧 过滤器管理
- **预设过滤器**：选择内置的常用过滤器模板，包括：
  - `高难度副本-莫古力`
  - `极神挑战`
  - `零式团队`
  - `需要坦克的队伍`
  - `需要治疗的队伍`
  - `速通团队`
  - `练习向团队`
  - `固定队招募`
- **自定义过滤器**：手动创建个性化过滤条件
- **启用/禁用**：灵活控制哪些过滤器生效
- **持久化保存**：所有设置自动保存到 `config.json`

#### 🎯 监视目标管理
- **添加监视**：输入招募ID开始监视
- **状态追踪**：实时监控招募状态变化
- **自动清理**：招募过期或消失时自动移除

## 配置说明

### API缓存机制
- **API服务器缓存**：30秒（查询参数相同时返回缓存结果）
- **Cloudflare缓存**：30秒
- **总延迟**：最多60秒数据延迟
- **建议设置**：检查间隔 ≥ 90秒

### 默认配置
```json
{
  "monitor": {
    "check_interval": 90,        // 检查间隔（秒）
    "expire_threshold": 300,     // 过期阈值（秒）
    "enable_system_notification": true,  // 系统通知
    "base_url": "http://xivpf.littlenightmare.top/api"
  }
}
```

## 使用示例

### 监视高难度副本招募
1. 进入"管理过滤器" → "添加过滤器"
2. 选择预设 "高难度副本-莫古力"
3. 返回主菜单，选择"开始监视"

### 监视特定招募
1. 通过"搜索招募"找到感兴趣的招募
2. 记下招募ID（如：1234567890）
3. 进入"管理监视目标" → "添加监视目标"
4. 输入招募ID

### 自定义过滤条件
一个自定义过滤器的例子：
```
分类：HighEndDuty
大区：莫古力
搜索关键字：极
最少空位数：1
排除已有职业：BLM WHM DRG（排除已有黑魔、白魔、龙骑的队伍）
内容关键字过滤：速通 练习 (只显示包含“速通”或“练习”的招募)
```

### 排除职业功能示例
如果你是一名坦克玩家，想找一个还缺一个坦克位置的队伍，可以在 "排除已有职业" 中输入：
```
PLD WAR DRK GNB
```
程序会自动过滤掉那些已经有 `骑士(PLD)`、`战士(WAR)`、`暗黑骑士(DRK)` 或 `绝枪战士(GNB)` 的招募。

### 内容关键字过滤示例
如果你只想找 "速通" 或 "刷榜" 的队伍，可以在 "内容关键字过滤" 中输入：
```
速通 刷榜
```
程序会只显示招募描述中包含这些词的队伍。

常用职业代码：
- **坦克**：PLD(骑士) WAR(战士) DRK(暗黑) GNB(绝枪)
- **治疗**：WHM(白魔) SCH(学者) AST(占星) SGE(贤者)
- **近战**：DRG(龙骑) MNK(武僧) NIN(忍者) SAM(武士) RPR(钐镰) VPR(蝰蛇)
- **远程**：BRD(诗人) MCH(机工) DNC(舞者)
- **法师**：BLM(黑魔) SMN(召唤) RDM(赤魔) PCT(绘灵)

## 文件说明

- `main.py` - 主程序入口
- `models.py` - 数据模型定义
- `api_client.py` - API客户端
- `monitor.py` - 监视器核心逻辑
- `notifier.py` - 通知系统
- `config.py` - 配置管理
- `job_mappings.py` - 职业代码映射（从游戏数据表加载）
- `data/ClassJob.csv` - FFXIV游戏职业数据表
- `config.json` - 配置文件（运行后自动生成）
- `xivpf_monitor.log` - 运行日志

## 注意事项

1. **网络延迟**：由于双重缓存，数据可能有最多60秒延迟
2. **检查频率**：不建议设置过短的检查间隔（建议≥90秒）
3. **系统通知**：Windows系统需要允许Python应用发送通知
4. **API限制**：请合理使用，避免对服务器造成压力

## API参考

本工具基于以下API构建：
- **招募列表**：`GET /listings`
- **招募详情**：`GET /listing/{id}`

详细API文档：https://github.com/LittleNightmare/remote-party-finder/wiki/API-Usage

## 故障排除

### 常见问题
1. **找不到招募**：检查过滤条件是否过于严格
2. **通知不工作**：检查系统通知权限设置
3. **连接失败**：检查网络连接和API服务状态
4. **程序崩溃**：查看 `xivpf_monitor.log` 获取详细错误信息

### 日志位置
- 运行日志：`xivpf_monitor.log`
- 配置文件：`config.json`

## 许可证

本项目遵循 MIT 许可证。 